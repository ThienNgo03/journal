<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Version1.Features.Subscriptions.Page"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:local="clr-namespace:Version1.Features.Subscriptions"
    xmlns:syncfusionToolkit="http://schemas.syncfusion.com/maui/toolkit"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    Appearing="ContentPage_Appearing"
    BackgroundColor="#000000">
    <ContentPage.Resources>
        <x:Array x:Key="AppUsages" Type="{x:Type local:AppUsage}">
            <local:AppUsage
                Company="Google"
                DayLeft="12"
                Discount="$10.98 (-10%)"
                Hex="#FF0000"
                Icon="youtube.png"
                Id="0fcfd3da-6b0f-4e71-9481-8e6432371d2e"
                IsDiscountApplied="True"
                IsPaid="True"
                Price="19.99"
                Subscription="YouTube"
                UsagePercent="14" />
            <local:AppUsage
                Company="Apple"
                DayLeft="15"
                Hex="#FF4E6B"
                Icon="apple_music.jpg"
                Id="cb6f0178-ff82-4ae6-9785-9b79e6e53494"
                IsDiscountApplied="False"
                IsPaid="True"
                Price="17.99"
                Subscription="Apple Music"
                UsagePercent="13" />
            <local:AppUsage
                Company="Spotify"
                DayLeft="20"
                Discount="$1.60 (-10%)"
                Hex="#1ED760"
                Icon="spotify.png"
                Id="9b98d9b4-a6c4-4415-9c1e-8878f00ea05d"
                IsDiscountApplied="False"
                IsDiscountAvailable="True"
                IsPaid="True"
                Price="15.99"
                Subscription="Spotify"
                UsagePercent="11" />
            <local:AppUsage
                Company="Amazon"
                DayLeft="25"
                Discount="$1.40 (-10%)"
                Hex="#00A8E1"
                Icon="amazon_prime.png"
                Id="8ecfbd9d-9515-4c98-a3b9-8bfc12e311fd"
                IsDiscountApplied="False"
                IsPaid="True"
                Price="13.99"
                Subscription="Amazon Prime"
                UsagePercent="10" />
            <local:AppUsage
                Company="Netflix Inc."
                DayLeft="18"
                Discount="$1.30 (-10%)"
                Hex="#E50914"
                Icon="netflix.png"
                Id="5d442a00-1c38-4cfc-82ac-f7f2c2666dad"
                IsDiscountApplied="True"
                IsPaid="True"
                Price="12.99"
                Subscription="Netflix"
                UsagePercent="9" />
            <local:AppUsage
                Company="Disney"
                DayLeft="22"
                Discount="$1.10 (-10%)"
                Hex="#113CCF"
                Icon="disney_plus.jpg"
                Id="fa8daf30-0d3f-41f8-951b-7b34871257f4"
                IsDiscountApplied="False"
                IsPaid="True"
                Price="10.99"
                Subscription="Disney+"
                UsagePercent="8" />
            <local:AppUsage
                Company="Sony"
                DayLeft="16"
                Discount="$0.90 (-10%)"
                Hex="#F47521"
                Icon="crunchyroll.jpg"
                Id="7f2c7d3b-2bbd-4eec-89df-d098a5a700db"
                IsDiscountApplied="True"
                IsPaid="False"
                Price="8.99"
                Subscription="Crunchyroll"
                UsagePercent="7" />
            <local:AppUsage
                Company="Warner Bros."
                DayLeft="10"
                Discount="$0.80 (-10%)"
                Hex="#5A2D82"
                Icon="warner_bros.jpg"
                Id="e7cd7a94-51b8-496f-915b-54a8ad0c9c12"
                IsDiscountApplied="False"
                IsPaid="True"
                Price="7.99"
                Subscription="HBO Max"
                UsagePercent="6" />
            <local:AppUsage
                Company="Hostinger"
                DayLeft="30"
                Discount="$0.70 (-10%)"
                Hex="#673AB7"
                Icon="hostinger.jpg"
                Id="b82a381b-ac97-45fa-af3a-829a2ea129f2"
                IsDiscountApplied="True"
                IsPaid="True"
                Price="6.99"
                Subscription="Hostinger VPS"
                UsagePercent="5" />
            <local:AppUsage
                Company="GitHub"
                DayLeft="14"
                Discount="$0.60 (-10%)"
                Hex="#333333"
                Icon="github.png"
                Id="d7fdd751-b830-48e5-8196-e99e82c5d42b"
                IsDiscountApplied="False"
                IsPaid="True"
                Price="5.99"
                Subscription="GitHub Pro"
                UsagePercent="4" />
            <local:AppUsage
                Company="Microsoft"
                DayLeft="19"
                Discount="$0.50 (-10%)"
                Hex="#512BD4"
                Icon="dotnet_bot.png"
                Id="f3a2da1b-6018-4c80-b147-9dd7f75f40b8"
                IsDiscountApplied="True"
                IsPaid="True"
                Price="4.99"
                Subscription=".NET Bot"
                UsagePercent="3" />
            <local:AppUsage
                Company="Microsoft"
                DayLeft="28"
                Discount="$0.40 (-10%)"
                Hex="#0078D4"
                Icon="onedrive.png"
                Id="cb628193-c39a-42eb-8cd1-ea5fb9e858d7"
                IsDiscountApplied="False"
                IsPaid="True"
                Price="3.99"
                Subscription="OneDrive"
                UsagePercent="2" />
            <local:AppUsage
                Company="Microsoft"
                DayLeft="17"
                Discount="$0.30 (-10%)"
                Hex="#008AD7"
                Icon="azure.png"
                Id="bee1cbe1-0169-4511-8b5f-0c0832a64e7f"
                IsDiscountApplied="True"
                IsPaid="False"
                Price="2.99"
                Subscription="Azure Dev"
                UsagePercent="1" />
            <local:AppUsage
                Company="Amazon"
                DayLeft="26"
                Discount="$0.20 (-10%)"
                Hex="#232F3E"
                Icon="aws.png"
                Id="4ed93f3c-ea07-4d83-8304-bd1c62962777"
                IsDiscountApplied="False"
                IsPaid="True"
                Price="1.99"
                Subscription="AWS Free Tier"
                UsagePercent="1" />
        </x:Array>

        <x:Array x:Key="CustomBrushes" Type="{x:Type Brush}">
            <SolidColorBrush Color="#FF4C4C" />
            <!--  YouTube: đỏ sáng  -->
            <SolidColorBrush Color="#FF6F91" />
            <!--  Apple Music: hồng đào  -->
            <SolidColorBrush Color="#4CAF50" />
            <!--  Spotify: xanh lá sáng  -->
            <SolidColorBrush Color="#00BFFF" />
            <!--  Amazon Prime: xanh dương sáng  -->
            <SolidColorBrush Color="#FF6347" />
            <!--  Netflix: đỏ cam  -->
            <SolidColorBrush Color="#5C6BC0" />
            <!--  Disney+: xanh tím sáng  -->
            <SolidColorBrush Color="#FFA500" />
            <!--  Crunchyroll: cam sáng  -->
            <SolidColorBrush Color="#BA68C8" />
            <!--  HBO Max: tím pastel  -->
            <SolidColorBrush Color="#BDBDBD" />
            <!--  Hostinger: xám sáng  -->
            <SolidColorBrush Color="#9C27B0" />
            <!--  GitHub: tím sáng  -->
            <SolidColorBrush Color="#64B5F6" />
            <!--  .NET Bot: xanh trời  -->
            <SolidColorBrush Color="#4FC3F7" />
            <!--  OneDrive: xanh biển sáng  -->
            <SolidColorBrush Color="#90CAF9" />
            <!--  Azure: xanh lam pastel  -->
            <SolidColorBrush Color="#FFD700" />
            <!--  AWS: vàng sáng  -->
        </x:Array>

        <local:SumPriceConverter x:Key="SumPriceConverter" />
        <local:USDToVNDConverter x:Key="USDToVNDConverter" />
        <local:TextDecorationsConverter x:Key="TextDecorationsConverter" />
        <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        <toolkit:IsNullConverter x:Key="IsNullConverter" />
        <toolkit:IsNotNullConverter x:Key="IsNotNullConverter" />

    </ContentPage.Resources>

    <Grid Padding="16" RowSpacing="16">
        <CollectionView
            x:Name="MainList"
            ItemsSource="{Binding AppUsages}"
            SelectionChanged="CollectionView_SelectionChanged"
            SelectionMode="Single">
            <CollectionView.Header>
                <Border
                    Grid.Row="1"
                    Padding="16"
                    BackgroundColor="#171717"
                    MaximumHeightRequest="800"
                    Stroke="#fafafa"
                    StrokeShape="RoundRectangle 8"
                    StrokeThickness="0.5">
                    <VerticalStackLayout Spacing="8">

                        <Label
                            FontAttributes="Bold"
                            FontSize="Subtitle"
                            HorizontalOptions="Center"
                            Text="{Binding Month}"
                            TextColor="White"
                            TextDecorations="Underline" />
                        <syncfusionToolkit:SfCircularChart>
                            <syncfusionToolkit:PieSeries
                                EnableAnimation="True"
                                EnableTooltip="True"
                                IsVisibleOnLegend="True"
                                ItemsSource="{Binding ChartSlices}"
                                PaletteBrushes="{Binding CustomBrushes}"
                                Radius="1"
                                ShowDataLabels="True"
                                XBindingPath="Subscription"
                                YBindingPath="Price">

                                <syncfusionToolkit:PieSeries.LabelTemplate>
                                    <DataTemplate>
                                        <HorizontalStackLayout>
                                            <Label
                                                FontSize="10"
                                                Text="{Binding Item.Subscription}"
                                                TextColor="#fafafa" />
                                            <Label
                                                FontSize="10"
                                                Text=" : "
                                                TextColor="#fafafa" />
                                            <Label
                                                FontSize="10"
                                                Text="{Binding Item.Price, StringFormat='{0:N0}₫'}"
                                                TextColor="#fafafa" />
                                        </HorizontalStackLayout>
                                    </DataTemplate>
                                </syncfusionToolkit:PieSeries.LabelTemplate>



                                <syncfusionToolkit:PieSeries.DataLabelSettings>
                                    <syncfusionToolkit:CircularDataLabelSettings LabelPosition="Inside" SmartLabelAlignment="Shift" />
                                </syncfusionToolkit:PieSeries.DataLabelSettings>
                            </syncfusionToolkit:PieSeries>
                            <syncfusionToolkit:SfCircularChart.Legend>
                                <syncfusionToolkit:ChartLegend>
                                    <syncfusionToolkit:ChartLegend.LabelStyle>
                                        <syncfusionToolkit:ChartLegendLabelStyle TextColor="White" />
                                    </syncfusionToolkit:ChartLegend.LabelStyle>
                                </syncfusionToolkit:ChartLegend>
                            </syncfusionToolkit:SfCircularChart.Legend>
                        </syncfusionToolkit:SfCircularChart>
                        <Label
                            FontAttributes="Bold"
                            HorizontalOptions="Center"
                            Text="{Binding TotalPrice, StringFormat='Total: {0:N0}₫'}"
                            TextColor="#fafafa" />
                        <syncfusionToolkit:SfButton
                            x:Name="AddButton"
                            Background="#2b2b2b"
                            Clicked="AddButton_Clicked"
                            CornerRadius="4"
                            Text="Add"
                            TextColor="White" />
                    </VerticalStackLayout>
                </Border>
            </CollectionView.Header>
            <CollectionView.ItemsLayout>
                <GridItemsLayout
                    HorizontalItemSpacing="10"
                    Orientation="Vertical"
                    VerticalItemSpacing="16" />
            </CollectionView.ItemsLayout>
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Border
                        Padding="16"
                        BackgroundColor="#171717"
                        Stroke="#fafafa"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0.5">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <VerticalStackLayout Spacing="4">

                                <Image
                                    HeightRequest="86"
                                    Source="{Binding Icon, Mode=OneWay}"
                                    WidthRequest="86" />

                                <BoxView
                                    BackgroundColor="{Binding Hex}"
                                    CornerRadius="2"
                                    HeightRequest="6"
                                    WidthRequest="86" />
                            </VerticalStackLayout>
                            <VerticalStackLayout
                                Grid.Column="1"
                                Grid.ColumnSpan="2"
                                Padding="8"
                                Spacing="8">
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="14"
                                    Text="{Binding Company}"
                                    TextColor="#fafafa"
                                    VerticalOptions="Center" />
                                <Label
                                    FontSize="12"
                                    Text="{Binding Subscription}"
                                    TextColor="#fafafa"
                                    VerticalOptions="Center" />
                            </VerticalStackLayout>
                            <Grid Grid.Column="2">
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="14"
                                    HorizontalOptions="End"
                                    Text="{Binding Price, StringFormat='{0:N0}₫'}"
                                    TextColor="#fafafa"
                                    TextDecorations="{Binding IsDiscountApplied, Converter={StaticResource TextDecorationsConverter}}" />
                                <Label
                                    HorizontalOptions="End"
                                    Text="{Binding Discount}"
                                    TextColor="#fafafa"
                                    VerticalOptions="Center" />

                                <HorizontalStackLayout Spacing="8" VerticalOptions="End">

                                    <Border
                                        Padding="4,2,4,2"
                                        BackgroundColor="#292929"
                                        IsVisible="{Binding IsDiscountApplied}"
                                        Stroke="#292929"
                                        StrokeShape="RoundRectangle 4">
                                        <Label
                                            FontSize="11"
                                            Text="Discount applied"
                                            TextColor="#fafafa"
                                            VerticalOptions="Center" />
                                    </Border>

                                    <Border
                                        Padding="4,2,4,2"
                                        BackgroundColor="#292929"
                                        IsVisible="{Binding IsDiscountAvailable}"
                                        Stroke="#292929"
                                        StrokeShape="RoundRectangle 4">
                                        <Label
                                            FontSize="11"
                                            Text="Discount available"
                                            TextColor="#fafafa"
                                            VerticalOptions="Center" />
                                    </Border>

                                    <Border
                                        Padding="4,2,4,2"
                                        BackgroundColor="#292929"
                                        IsVisible="{Binding IsPaid}"
                                        Stroke="#292929"
                                        StrokeShape="RoundRectangle 4">
                                        <Label
                                            FontSize="11"
                                            Text="Paid"
                                            TextColor="#fafafa"
                                            VerticalOptions="Center" />
                                    </Border>

                                    <Border
                                        Padding="4,2,4,2"
                                        BackgroundColor="#292929"
                                        Stroke="#292929"
                                        StrokeShape="RoundRectangle 4">

                                        <Label FontSize="11" TextColor="#fafafa">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="{Binding DayLeft}" />
                                                    <Span Text=" " />
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                    </Border>
                                </HorizontalStackLayout>
                            </Grid>
                        </Grid>
                        <VisualStateManager.VisualStateGroups>
                            <VisualStateGroup Name="CommonStates">
                                <VisualState Name="Normal" />
                                <VisualState Name="Selected">
                                    <VisualState.Setters>
                                        <!--  Transparent background removes highlight  -->
                                        <Setter Property="BackgroundColor" Value="Transparent" />
                                    </VisualState.Setters>
                                </VisualState>
                            </VisualStateGroup>
                        </VisualStateManager.VisualStateGroups>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </Grid>
</ContentPage>